#!/bin/bash

API_CONFIG=deploy/environments/production-app/api.yaml.gotmpl
UIX_CONFIG=deploy/environments/production-app/uix.yaml.gotmpl
SEC_CONFIG=deploy/environments/production-app/secrets.yaml

# 03 RESOURCE
if grep -q "memory: 8Mi" $API_CONFIG; then
  RESOURCE=true
fi

# 04 LOGS
if grep -q "level: info" $API_CONFIG; then
  LOGS=true
fi

# 05 SECRETS
if ! grep -q "MP7L7goFiZtmRlWPrakbY2Web2rQA+qwjjfUQl1zOgmUU2u477DMt3rcteVQ,iv" $SEC_CONFIG; then
  SECRETS=true
fi

# 06 REPLICA
if grep -q "replicaCount: 2" $API_CONFIG; then
  REPLICA=true
fi

# 07 ENVIRONMENTS
if grep -q api.*-apis.rebirthofhope.ru $UIX_CONFIG; then
  ENVIRONMENTS=true
fi

# 08 CORS
if grep -q origins.*uix.rebirthofhope.ru $API_CONFIG; then
  CORS=true
fi

# 09 INGRESS
if grep -q "extraIngress" $API_CONFIG; then
  INGRESS=true
fi

# 10 VOLUMES
if grep -q "mountPath: /.output/public/arts" $UIX_CONFIG; then
  VOLUME=true
fi

# BONUS FEATURES

# [[ -z $RESOURCE ]]      && echo "üçÑ RESOURCE"       || echo "üçÄ RESOURCE"
# [[ -z $LOGS ]]          && echo "üçÑ LOGS"           || echo "üçÄ LOGS"
# [[ -z $SECRETS ]]       && echo "üçÑ SECRETS"        || echo "üçÄ SECRETS"
# [[ -z $REPLICA ]]       && echo "üçÑ REPLICA"        || echo "üçÄ REPLICA"
# [[ -z $ENVIRONMENTS ]]  && echo "üçÑ ENVIRONMENTS"   || echo "üçÄ ENVIRONMENTS"
# [[ -z $CORS ]]          && echo "üçÑ CORS"           || echo "üçÄ CORS"
# [[ -z $INGRESS ]]       && echo "üçÑ INGRESS"        || echo "üçÄ INGRESS"
# [[ -z $VOLUME ]]        && echo "üçÑ VOLUME"         || echo "üçÄ VOLUMES"

TASKS=""

[[ -z $RESOURCE ]]      || TASKS="${TASKS} tasks[resources]=true"
[[ -z $LOGS ]]          || TASKS="${TASKS} tasks[logs]=true"
[[ -z $SECRETS ]]       || TASKS="${TASKS} tasks[secrets]=true"
[[ -z $REPLICA ]]       || TASKS="${TASKS} tasks[replicas]=true"
[[ -z $ENVIRONMENTS ]]  || TASKS="${TASKS} tasks[envs]=true"
[[ -z $CORS ]]          || TASKS="${TASKS} tasks[cors]=true"
[[ -z $INGRESS ]]       || TASKS="${TASKS} tasks[ingress]=true"
[[ -z $VOLUME ]]        || TASKS="${TASKS} tasks[volume]=true"

https --quiet POST rebirthofhope.ru/api/verify call=$CALL $TASKS
